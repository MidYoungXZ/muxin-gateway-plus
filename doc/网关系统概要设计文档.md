# 高性能API网关系统概要设计文档

---

📈 监控大屏 <p>
├── 实时请求统计 → 展示网关的实时请求量、响应时间、错误率、状态码分布等核心指标 🚧（WebSocket已实现，数据推送未完成）<p>
├── 路由调用监控 → 查看每条路由的调用趋势、异常分布、慢接口排行 ❌（未实现）<p>
├── 过滤器命中监控 → 限流、鉴权、熔断等过滤器命中次数与影响范围统计 ❌（未实现）<p>
<p>
📌 路由管理<p>
├── 路由列表           → 管理所有动态路由配置，支持新增/编辑、启用禁用、搜索、跳转配置页 ✅<p>
├── 路由测试工具       → 提供模拟请求工具，验证路由是否按配置转发，排查中间链路处理问题 ❌（未实现）<p>
├── 服务管理           → 维护注册中心的后端服务节点，包含节点上下线状态监控、健康探测、启用/禁用等操作 🚧（基础功能实现）<p>
├── 负载均衡配置       → 为每条路由配置负载均衡策略（如轮询、加权轮询、最少连接、IP 哈希等），支持节点权重调整和策略参数配置 🚧（仅轮询实现）<p>
└── 过滤器管理         → 配置请求处理链中的过滤器，支持 URL 截取、添加请求头、限流、鉴权、路径重写等功能，支持启用/禁用和顺序控制 🚧（基础过滤器实现）<p>
<p>
🔒 鉴权规则 ❌（未实现）
├── API 权限控制       → 配置某些路由的访问权限规则，支持基于用户、角色、Token、IP 等限制访问<p>
└── 白名单配置         → 配置无需鉴权的 IP / Token / Header 白名单列表，用于放通特定请求来源<p>
<p>
🧩 系统管理<p>
├── 👤 用户管理        → 管理后台系统用户账号，支持新增、编辑、启用、禁用、角色绑定、密码重置等 ✅<p>
├── 👥 角色管理        → 定义角色并关联权限，支持多角色绑定、权限继承等 ✅（权限验证暂时禁用）<p>
├── 🏢 部门管理        → 构建多级组织结构，用于用户归属、数据权限隔离 ❌（未实现）<p>
├── 🔐 权限管理        → 管理权限点（菜单权限 / 接口权限 / 按钮权限），支持权限码分组与绑定角色 ✅（基础结构实现）<p>
├── 📜 操作日志        → 查看用户的系统操作日志、登录日志、异常行为记录，支持搜索和导出 🚧（基础日志实现）<p>
└── ⚙️ 系统配置        → 配置网关系统基础参数，如系统名称、Token 超时时间、是否启用某些功能模块，以及手动触发配置热刷新等 ❌（未实现）<p>
<p>
---

## 1. 项目概述

### 1.1 项目背景

随着微服务架构的普及，企业内部服务数量急剧增加，服务间的调用关系变得复杂。需要一个高性能的API网关来统一管理服务入口，提供路由转发、负载均衡、协议转换等功能。

### 1.2 项目目标

- 构建一个支持10000+ QPS的高性能API网关 🚧（未进行性能测试）
- 提供灵活的路由转发和负载均衡能力 ✅
- 支持协议转换和请求/响应转换 🚧（仅HTTP协议）
- 提供友好的管理界面 ✅
- 保证99.9%的可用性 ❌（未实现高可用）
- 预留扩展能力，支持后续功能迭代 ✅

### 1.3 系统定位

本网关定位为企业级API网关，主要用于：

- 统一服务入口 ✅
- 流量管理和分发 ✅
- 协议适配和转换 🚧（架构支持，仅HTTP实现）
- 服务治理的第一道防线 🚧（基础功能实现）

## 2. 系统架构设计

### 2.1 整体架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                         前端管理界面 (Vue3) ✅                      │
├─────────────────────────────────────────────────────────────────┤
│                          管理API层 ✅                              │
├─────────────────────────────────────────────────────────────────┤
│                         网关核心层（简化后）                          │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐            │
│  │增强路由管理✅ │  │  过滤器链 ✅  │  │  全局配置 ✅ │            │
│  └─────────────┘  └─────────────┘  └─────────────┘            │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐            │
│  │  协议转换 🚧  │  │请求/响应转换❌│  │  服务发现 ✅  │            │
│  └─────────────┘  └─────────────┘  └─────────────┘            │
├─────────────────────────────────────────────────────────────────┤
│                      Netty网络层 ✅                               │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐            │
│  │HTTP Server ✅ │  │HTTP Client ✅│  │  连接池管理✅ │            │
│  └─────────────┘  └─────────────┘  └─────────────┘            │
└─────────────────────────────────────────────────────────────────┘
```

### 2.2 核心组件说明

#### 2.2.1 Netty网络层

- **HTTP Server**: 基于Netty实现的高性能HTTP服务器 ✅
- **HTTP Client**: 异步非阻塞的HTTP客户端 ✅
- **连接池管理**: 管理与后端服务的连接池 ✅

#### 2.2.2 网关核心层（2025-01-20架构简化）

- **增强路由管理**: EnhancedRouteManager集成路由、负载均衡、过滤器管理 ✅
- **全局配置**: GlobalRouteConfig支持全局默认配置和继承 ✅
- **过滤器链**: 前置过滤器和后置过滤器 🚧（仅前置过滤器）
- **路由配置转换**: RouteConfigConverter统一创建和管理组件 ✅
- **协议转换**: HTTP版本转换等 ❌（未实现）
- **请求/响应转换**: 数据格式转换 ❌（未实现）
- **服务发现**: 与注册中心集成 ✅（Nacos已集成）

**架构简化说明**:
- ❌ 移除了独立的FilterManager、LoadBalanceManager、PredicateManager
- ✅ 功能集成到RouteConfigConverter，使用Factory模式
- ✅ 每个路由完全隔离，避免配置冲突
- ✅ 支持动态路由更新（重建策略）

#### 2.2.3 管理层

- **管理API**: RESTful管理接口 ✅
- **配置管理**: 路由、过滤器等配置 ✅
- **监控统计**: 性能指标收集 🚧（框架实现，数据未集成）

### 2.3 数据流转图（简化后）

```
客户端请求 → Netty Server → EnhancedRouteManager → 全局+路由过滤器 → 集成负载均衡
    ↓                            ↓                    ↓                ↓
响应返回 ← 后置过滤器链 ← RouteConfigConverter ← Netty Client ← 后端服务
```

**流程说明**：
1. EnhancedRouteManager集成路由匹配和管理
2. GlobalRouteConfig自动合并全局和路由配置
3. RouteConfigConverter负责组件创建和负载均衡
4. 每个路由独立处理，完全隔离

## 3. 功能设计

### 3.1 路由转发功能

#### 3.1.1 路由匹配规则

- **路径匹配**: 精确匹配、前缀匹配、正则匹配 ✅
- **请求方法匹配**: GET、POST、PUT、DELETE等 ✅
- **请求头匹配**: 基于Header的路由 ❌（未实现）
- **参数匹配**: Query参数和Form参数匹配 ❌（未实现）

#### 3.1.2 路由配置示例 ✅

```yaml
routes:
  - id: user-service
    uri: lb://user-service
    predicates:
      - Path=/api/users/**
      - Method=GET,POST
    filters:
      - StripPrefix=1
```

### 3.2 负载均衡功能（架构简化）

#### 重构说明
- ❌ **移除LoadBalanceManager**: 负载均衡功能集成到RouteConfigConverter中
- ✅ **配置驱动**: 通过LoadBalanceDefinition定义策略
- ✅ **内置算法**: RouteConfigConverter内置多种负载均衡算法
- ✅ **路由隔离**: 每个路由独立的负载均衡实例

#### 3.2.1 负载均衡算法

- **轮询（Round Robin）**: 依次分发请求 ✅
- **随机（Random）**: 随机选择服务实例 ✅（新实现）
- **加权轮询（Weighted Round Robin）**: 根据权重分配 🚧（基础实现）
- **最少连接（Least Connections）**: 选择连接数最少的实例 ❌
- **一致性哈希（Consistent Hash）**: 基于请求特征的哈希 🚧（基础实现）

#### 3.2.2 健康检查

- **主动健康检查**: 定期探测服务健康状态 ❌（未实现）
- **被动健康检查**: 根据请求失败率判断 🚧（基础实现）
- **熔断机制**: 自动隔离故障服务 ❌（未实现）

### 3.3 协议转换功能 ❌

#### 3.3.1 HTTP协议版本转换

- HTTP/1.1 → HTTP/2 ❌
- HTTP/2 → HTTP/1.1 ❌

#### 3.3.2 协议适配扩展点

- 预留WebSocket支持 ❌
- 预留gRPC支持 ❌
- 预留TCP/UDP支持 ❌

### 3.4 请求/响应转换功能 ❌

#### 3.4.1 请求转换

- **请求头转换**: 添加、删除、修改请求头 ❌
- **请求体转换**: JSON ↔ XML ↔ Form ❌
- **参数转换**: 参数映射和转换 ❌

#### 3.4.2 响应转换

- **响应头转换**: 添加、删除、修改响应头 ❌
- **响应体转换**: 数据格式转换 ❌
- **响应包装**: 统一响应格式 ❌

### 3.5 管理功能

#### 3.5.1 配置管理

- 路由配置的CRUD操作 ✅
- 过滤器配置管理 🚧（基础实现）
- 服务实例管理 ✅

#### 3.5.2 监控统计

- QPS/TPS实时监控 🚧（框架实现）
- 响应时间分布 ❌
- 错误率统计 🚧（框架实现）
- 服务调用链路追踪 ❌

## 4. 技术选型

### 4.1 后端技术栈

| 技术组件    | 选型              | 说明            |
|---------|-----------------|---------------|
| 开发语言    | Java 17         | 性能优秀，生态完善     |
| 基础框架    | Spring Boot 3.x | 简化开发，易于集成     |
| 网络框架    | Netty 4.x       | 高性能异步网络框架     |
| HTTP客户端 | AsyncHttpClient | 基于Netty的异步客户端 |
| 序列化     | Jackson         | JSON处理        |
| 日志框架    | Log4j2          | 异步日志，性能更优     |
| 监控组件    | Micrometer      | 指标收集          |

### 4.2 前端技术栈

| 技术组件    | 选型           | 说明         |
|---------|--------------|------------|
| 框架      | Vue 3        | 渐进式框架，性能优秀 |
| UI组件库   | Element Plus | 企业级组件库     |
| 状态管理    | Pinia        | Vue3官方推荐   |
| 路由      | Vue Router 4 | 官方路由       |
| HTTP客户端 | Axios        | 请求库        |
| 图表      | ECharts      | 数据可视化      |

### 4.3 部署方案

- 打包方式：前后端一体化JAR包
- 运行环境：JDK 17+
- 部署模式：单机部署，预留集群扩展

## 5. 性能设计

### 5.1 性能目标

- **并发能力**: 10000+ QPS ❌（未测试）
- **响应延迟**: P99 < 10ms（不含后端服务时间）❌（未测试）
- **可用性**: 99.9% ❌（未实现高可用）
- **CPU使用率**: < 70%（满载情况下）❌（未测试）
- **内存使用**: < 4GB ❌（未测试）

### 5.2 性能优化策略

#### 5.2.1 网络层优化

- 使用Epoll（Linux）提升I/O性能 ✅
- 合理配置线程池大小 ✅
- 启用TCP_NODELAY减少延迟 ✅
- 使用对象池减少GC ❌（未实现）

#### 5.2.2 业务层优化

- 路由匹配使用Trie树或哈希表 🚧（使用简单匹配）
- 过滤器链使用责任链模式 ✅
- 异步非阻塞处理 ✅
- 本地缓存热点数据 ❌（未实现）

#### 5.2.3 JVM优化

```bash
-Xms2g -Xmx2g
-XX:+UseG1GC
-XX:MaxGCPauseMillis=100
-XX:+ParallelRefProcEnabled
-XX:+DisableExplicitGC
```

## 6. 安全设计

### 6.1 安全措施

- HTTPS支持 ❌（未实现）
- 请求签名验证（预留）❌
- 访问控制（预留）❌
- 防重放攻击（预留）❌
- SQL注入防护 ✅（MyBatis-Plus）
- XSS防护 ❌（未实现）

### 6.2 管理端安全

- 登录认证 ✅（Sa-Token）
- 权限控制 ✅（权限验证暂时禁用）
- 操作审计 🚧（基础日志）
- 敏感信息加密 ✅（密码加密）

## 7. 扩展性设计

### 7.1 插件化架构

- SPI机制支持自定义过滤器 ✅
- 自定义负载均衡算法 ✅
- 自定义路由匹配规则 ✅
- 自定义协议支持 ✅（架构支持）

### 7.2 扩展点设计（架构简化后）

```java
// 过滤器扩展点（通过Factory创建）
public interface FilterFactory {
    Filter createFilter(FilterDefinition definition);
    String getFilterType();
}

// 负载均衡扩展点（集成到RouteConfigConverter）
public class RouteConfigConverter {
    // 内置负载均衡算法，支持扩展
    public EndpointAddress selectTarget(RouteTarget routeService, 
                                      List<EndpointAddress> targets,
                                      RequestContext context) {
        String strategy = getLoadBalanceStrategy(routeService);
        return switch (strategy) {
            case "ROUND_ROBIN" -> roundRobinSelect(targets, context);
            case "RANDOM" -> randomSelect(targets);
            case "WEIGHTED_ROUND_ROBIN" -> weightedRoundRobinSelect(targets, context);
            case "CONSISTENT_HASH" -> consistentHashSelect(targets, context, routeService);
            default -> customSelect(strategy, targets, context); // 扩展点
        };
    }
}

// 全局配置扩展点
public class GlobalRouteConfig {
    // 支持自定义配置合并策略
    public RouteDefinition mergeRouteDefinition(RouteDefinition routeDefinition) {
        // 可扩展的合并逻辑
    }
}

// 路由工厂扩展点
public interface RouteTargetFactory {
    RouteTarget createRouteTarget(RouteTargetDefinition definition);
    TargetType getSupportedType();
    void validateConfig(RouteTargetDefinition definition);
}
```

## 8. 部署架构

### 8.1 单机部署 ✅

```
┌─────────────────┐
│   Nginx(可选)    │
└────────┬────────┘
         │
┌────────▼────────┐
│  Muxin Gateway  │
│   (Port:8080)   │
└────────┬────────┘
         │
┌────────▼────────┐
│   后端服务集群    │
└─────────────────┘
```

### 8.2 未来集群部署（预留）❌

```
        ┌─────────────────┐
        │   负载均衡器     │
        └────────┬────────┘
                 │
    ┌────────────┼────────────┐
    │            │            │
┌───▼───┐   ┌───▼───┐   ┌───▼───┐
│Gateway│   │Gateway│   │Gateway│
│Node-1 │   │Node-2 │   │Node-3 │
└───┬───┘   └───┬───┘   └───┬───┘
    │            │            │
    └────────────┼────────────┘
                 │
        ┌────────▼────────┐
        │   后端服务集群    │
        └─────────────────┘
```

## 9. 开发计划

### 9.1 第一阶段：核心功能（2周）

- [x] 基础框架搭建 ✅
- [x] Netty服务器实现 ✅
- [x] 基本路由功能 ✅
- [ ] 性能优化 ❌
- [x] 负载均衡实现 🚧（仅轮询）

### 9.2 第二阶段：协议转换（1周）

- [ ] HTTP协议版本转换 ❌
- [ ] 请求/响应转换 ❌
- [ ] 数据格式转换 ❌

### 9.3 第三阶段：管理界面（2周）

- [x] Vue3项目搭建 ✅
- [x] 管理API开发 ✅
- [ ] 监控大屏开发 🚧（WebSocket已实现）
- [x] 路由配置管理 ✅

### 9.4 第四阶段：测试优化（1周）

- [ ] 性能测试 ❌
- [ ] 压力测试 ❌
- [ ] 稳定性测试 ❌
- [ ] 优化调整 ❌

## 10. 风险评估

### 10.1 技术风险

- **风险**: Netty使用复杂，可能出现内存泄漏
- **应对**: 严格的代码审查，使用Netty内存泄漏检测工具

### 10.2 性能风险

- **风险**: 单机性能可能无法达到10000 QPS
- **应对**: 预留集群扩展能力，优化算法和数据结构

### 10.3 稳定性风险

- **风险**: 长时间运行可能出现性能下降
- **应对**: 实现优雅关闭和重启，监控告警机制

## 11. 总结

本设计文档描述了一个高性能API网关的整体架构和实现方案。系统基于Netty构建，采用Spring Boot框架，提供路由转发、负载均衡、协议转换等核心功能，并配备Vue3开发的管理界面。

### 11.1 架构简化成果（2025-01-20重构）

**重构目标**: 简化架构，减少抽象层，提高系统可维护性和性能。

**主要成果**:
- ✅ **组件简化**: 将FilterManager、LoadBalanceManager、PredicateManager三个管理器简化为统一的RouteConfigConverter
- ✅ **配置集中**: 新增GlobalRouteConfig统一管理全局默认配置和继承机制
- ✅ **路由增强**: EnhancedRouteManager集成了所有管理功能，支持动态配置更新
- ✅ **完全隔离**: 每个路由独立创建实例，避免配置冲突和状态污染
- ✅ **工厂模式**: 使用Factory模式统一创建和管理组件，提高代码一致性

**性能改进**:
- 减少抽象层数，降低方法调用开销
- 简化组件依赖关系，提高启动速度
- 路由独立实例避免锁竞争，提升并发性能

**维护性提升**:
- 代码逻辑更加清晰，易于理解和维护
- 组件职责明确，降低修改影响范围
- 配置管理统一，减少重复代码

### 11.2 系统特点

通过架构简化和合理的设计优化，系统具备以下特点：
- **高性能**: 目标支持10000+ QPS（待性能测试验证）
- **易维护**: 简化后的架构降低了维护复杂度
- **可扩展**: 保留了良好的扩展性和插件化能力
- **配置灵活**: 支持全局配置继承和路由级配置覆盖 